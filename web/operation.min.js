function getQueryStringValue(key) {
  return decodeURIComponent(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + encodeURIComponent(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
}

var type = getQueryStringValue("type");
var str = getQueryStringValue("str");
if (type == 'doi') {
  var doiurl = "https://cors-anywhere.herokuapp.com/http://93.174.95.27/scimag/ads.php?doi=" + str;
  doiurl.replace(/\s/g, '');
  $.ajax({
    method: 'GET',
    dataType: 'text',
    url: doiurl,
  }).then(function (data) {
    var reg = new RegExp(/http:[\S]+doi=\S+&key=\w+/);
    var pdfUrl = data.match(reg)[0];
    //alert(pdfUrl);
    $.ajax({
      method: 'GET',
      dataType: 'text',
      url: '/web/viewer.js'
    }).then(function (viewer) {
      viewer = viewer.replace('tobereplace', "https://cors-anywhere.herokuapp.com/" + pdfUrl);
      eval(viewer);
      //alertalert("https://cors-anywhere.herokuapp.com/" + pdfUrl);
      var pdfjsframe = document.getElementById('viewer');
      pdfjsframe.contentWindow.PDFViewerApplication.open("a");
      //console.log(data);
    })
  })
}
else if (type == 'isbn') {
  var doiurl = "https://cors-anywhere.herokuapp.com/http://93.174.95.27/search.php?req=" + str;
  doiurl.replace(/\s/g, '');
  $.ajax({
    method: 'GET',
    dataType: 'text',
    url: doiurl,
  }).then(function (data) {
    var reg = new RegExp(/http:[\S]+md5=\w+/);
    //alert(data.match(reg) ? data.match(reg).length : 0);//若match返回不为null，则结果为true，输出match返回的数组(["test","test"])的长度
    for (var j = 0; j < data.match(reg).length; ++j) {
      //alert(data.match(reg)[j]);
      var liststr = data.match(reg)[j];
      var suffix = liststr.replace("http://libgen.io/ads.php?md5=", "");
      var libgenUrl = "https://cors-anywhere.herokuapp.com/http://library1.org/_ads/" + suffix;
      $.ajax({
        method: 'GET',
        dataType: 'text',
        url: libgenUrl,
      }).then(function (str1) {
        var reg2 = new RegExp(/http:[\S]+library1.org\/.+GET<\/a>/);
        var DownloadUrl = "https://cors-anywhere.herokuapp.com/" + str1.match(reg2)[0].replace("\">GET<\/a>", "");
        var pdfUrl = str1.match(reg2)[0].replace("\">GET<\/a>", "");
        //alertalert(pdfUrl);
        var cookies = document.cookie.split(";");

for (var i = 0; i < cookies.length; i++) {
    var cookie = cookies[i];
    var eqPos = cookie.indexOf("=");
    var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
}
        window.location.href = pdfUrl;
        /*$.ajax({
          method: 'GET',
          dataType: 'text',
          url: '/web/viewer.js',
        }).then(function (viewer) {
          viewer = viewer.replace('tobereplace', "https://cors-anywhere.herokuapp.com/" + pdfUrl);
          eval(viewer);
          alert("https://cors-anywhere.herokuapp.com/" + pdfUrl);
        })*/
        /*$.ajax({
          method: 'GET',
          headers: {
            'origin': 'a',
            'X-Requested-With': 'a',
            'accept':'application/octet-stream',
          },
          url: "https://cors-anywhere.herokuapp.com/" + pdfUrl,
        }).then(function (pdfData) {
          alert("https://cors-anywhere.herokuapp.com/" + pdfUrl);
          alert(pdfData);
          // Loaded via <script> tag, create shortcut to access PDF.js exports.
          var pdfjsLib = window['/build/pdf'];
          // The workerSrc property shall be specified.
          pdfjsLib.GlobalWorkerOptions.workerSrc = '/build/pdf.worker.js';
          // Using DocumentInitParameters object to load binary data.
          var loadingTask = pdfjsLib.getDocument({ data: pdfData });
        });*/
        /*var xhr = new XMLHttpRequest();
        var requestUrl = "https://cors-anywhere.herokuapp.com/" + pdfUrl
        xhr.open('GET', requestUrl, true);
        xhr.responseType = 'arraybuffer';

        xhr.onload = function (e) {
          
          var pdfData = new Uint8Array(this.response).buffer;
          var string = new TextDecoder("utf-8").decode(pdfData);
          alert(string);
          alert(requestUrl);
          //alert(xhr.request.headers);
          alert(xhr.getAllResponseHeaders());
          //console.log(pdfData);
          // Loaded via <script> tag, create shortcut to access PDF.js exports.
          var pdfjsLib = window['/build/pdf'];
          // The workerSrc property shall be specified.
          pdfjsLib.GlobalWorkerOptions.workerSrc = '/build/pdf.worker.js';
          // Using DocumentInitParameters object to load binary data.
          var loadingTask = pdfjsLib.getDocument({ data: pdfData });
          
        }
        
        xhr.send();*/
      });
    }
  })
}
else {
  $.ajax({
    method: 'GET',
    dataType: 'text',
    url: '/web/viewer.js'
  }).then(function (data) {
    data = data.replace('tobereplace', 'hello.pdf');
    eval(data);
    //console.log(data);
  })
}